<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>

    <button id="record">Start</button>
    <button id="stop">STOP</button>
    <div id="soundClips"></div>
    <progress min="0" max="100" value="0">0% complete</progress>
    <script>
        const record = document.getElementById('record');
        const stop = document.getElementById('stop');
        const soundClips = document.getElementById('soundClips');

        navigator.getUserMedia = (navigator.getUserMedia ||
            navigator.mozGetUserMedia ||
            navigator.msGetUserMedia ||
            navigator.webkitGetUserMedia);


        if (navigator.getUserMedia) {
            console.log('getUserMedia supported.');

            var constraints = { audio: true };
            var chunks = [];

            var onSuccess = function (stream) {
                var mediaRecorder = new MediaRecorder(stream);


                record.onclick = function () {
                    mediaRecorder.start();
                    console.log(mediaRecorder.state);
                    console.log("recorder started");
                    record.style.background = "red";
                    record.style.color = "black";
                }

                stop.onclick = function () {
                    mediaRecorder.stop();
                    console.log(mediaRecorder.state);
                    console.log("recorder stopped");
                    record.style.background = "";
                    record.style.color = "";
                    // mediaRecorder.requestData();
                }

                mediaRecorder.onstop = function (e) {
                    console.log("data available after MediaRecorder.stop() called.");

                    var clipName = prompt('Enter a name for your sound clip');

                    var clipContainer = document.createElement('article');
                    var clipLabel = document.createElement('p');
                    var audio = document.createElement('audio');
                    var deleteButton = document.createElement('button');

                    clipContainer.classList.add('clip');
                    audio.setAttribute('controls', '');
                    deleteButton.innerHTML = "Delete";
                    clipLabel.innerHTML = clipName;

                    clipContainer.appendChild(audio);
                    clipContainer.appendChild(clipLabel);
                    clipContainer.appendChild(deleteButton);
                    soundClips.appendChild(clipContainer);

                    audio.controls = true;
                    var blob = new Blob(chunks, { 'type': 'audio/ogg; codecs=opus' });
                    chunks = [];
                    var audioURL = window.URL.createObjectURL(blob);
                    audio.src = audioURL;
                    console.log("recorder stopped");

                    deleteButton.onclick = function (e) {
                        evtTgt = e.target;
                        evtTgt.parentNode.parentNode.removeChild(evtTgt.parentNode);
                    }
                    /*******************/
                    function upload(blobOrFile) {
                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', './', true);
                        xhr.onload = function (e) { /*...*/ };

                        // Слушаем процесс загрузки файла
                        var progressBar = document.querySelector('progress');
                        xhr.upload.onprogress = function (e) { // <<<
                            if (e.lengthComputable) {
                                progressBar.value = (e.loaded / e.total) * 100;
                                progressBar.textContent = progressBar.value; // Если браузер не поддерживает элемент progress
                            }
                        };

                        xhr.send(blob); // <<<
                    }

                    /************************/
                }

                mediaRecorder.ondataavailable = function (e) {
                    chunks.push(e.data);
                }
            }

            var onError = function (err) {
                console.log('The following error occured: ' + err);
            }

            navigator.getUserMedia(constraints, onSuccess, onError);
        } else {
            console.log('getUserMedia not supported on your browser!');
        }
    </script>
</body>

</html>